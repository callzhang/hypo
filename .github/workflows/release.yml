name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.2.2, v1.0.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.2)'
        required: true
        type: string

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
      
      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug
      
      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  build-macos:
    name: Build macOS App
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python (for icon generation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Build macOS App
        working-directory: macos
        run: |
          # Build the Swift package
          swift build -c release
          
          # Create app bundle structure if it doesn't exist
          if [ ! -d "HypoApp.app" ]; then
            mkdir -p HypoApp.app/Contents/MacOS
            mkdir -p HypoApp.app/Contents/Resources
          fi
          
          # Copy binary to app bundle (check actual build output)
          if [ -f ".build/release/HypoMenuBar" ]; then
            cp .build/release/HypoMenuBar HypoApp.app/Contents/MacOS/HypoMenuBar
          elif [ -f ".build/release/HypoMenuBarApp" ]; then
            cp .build/release/HypoMenuBarApp HypoApp.app/Contents/MacOS/HypoMenuBar
          else
            echo "Error: Binary not found. Available files:"
            find .build/release -type f || true
            exit 1
          fi
          chmod +x HypoApp.app/Contents/MacOS/HypoMenuBar
          
          # Create or update Info.plist
          cat > HypoApp.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>HypoMenuBar</string>
              <key>CFBundleIdentifier</key>
              <string>com.hypo.clipboard</string>
              <key>CFBundleName</key>
              <string>Hypo</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ github.ref_name }}</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF
          
          # Generate icons if script exists
          if [ -f "../scripts/generate-icons.py" ]; then
            python3 ../scripts/generate-icons.py || echo "Icon generation failed, continuing without icon"
          fi
      
      - name: Create macOS ZIP
        working-directory: macos
        run: |
          zip -r ../Hypo-macOS-${{ github.ref_name }}.zip HypoApp.app
      
      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: Hypo-macOS-${{ github.ref_name }}.zip
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-android, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog
      
      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          # Remove 'v' prefix if present for tag
          TAG_NAME="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG_NAME"
      
      - name: Download Android Debug APK
        uses: actions/download-artifact@v4
        with:
          name: android-debug-apk
          path: ./artifacts
      
      - name: Download Android Release APK
        uses: actions/download-artifact@v4
        with:
          name: android-release-apk
          path: ./artifacts
      
      - name: Download macOS App
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: ./artifacts
      
      - name: Rename artifacts with version
        run: |
          cd artifacts
          TAG_NAME="${{ steps.version.outputs.tag }}"
          mv app-debug.apk hypo-android-debug-${TAG_NAME}.apk
          mv app-release.apk hypo-android-release-${TAG_NAME}.apk
          # macOS zip already has version in name
          ls -lh
      
      - name: Generate release notes
        id: release-notes
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract changelog if available
          if [ -f changelog.md ]; then
            # Try to extract section for this version (customize as needed)
            CHANGELOG_SECTION=$(awk "/## \[?$VERSION\]?/,/## \[?v[0-9]/" changelog.md | head -n -1 || echo "")
          fi
          
          # Create release notes
          cat > release-notes.md << EOF
          # Release $VERSION
          
          ## Downloads
          
          - **Android (Release)**: \`hypo-android-release-${TAG_NAME}.apk\` (~15-20MB, optimized for production)
          - **Android (Debug)**: \`hypo-android-debug-${TAG_NAME}.apk\` (~47MB, for development/testing)
          - **macOS**: \`Hypo-macOS-${TAG_NAME}.zip\` (extract and move to Applications)
          
          ## Installation
          
          See [INSTALLATION.md](docs/INSTALLATION.md) for detailed installation instructions.
          
          ## Changes
          
          ${CHANGELOG_SECTION:-"See git log for changes."}
          
          ## Checksums
          
          \`\`\`
          SHA256 checksums:
          \`\`\`
          EOF
          
          # Add checksums
          cd artifacts
          for file in *.apk *.zip; do
            if [ -f "$file" ]; then
              SHA256=$(sha256sum "$file" | awk '{print $1}')
              echo "  $SHA256  $file" >> ../release-notes.md
            fi
          done
          cd ..
          
          echo "notes_path=release-notes.md" >> $GITHUB_OUTPUT
      
      - name: Delete existing release if present
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if gh release view "$TAG_NAME" &>/dev/null; then
            echo "Deleting existing release $TAG_NAME..."
            gh release delete "$TAG_NAME" --yes || true
          fi
        continue-on-error: true
      
      - name: Delete existing tag if present
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG_NAME" &>/dev/null; then
            echo "Deleting existing tag $TAG_NAME..."
            git tag -d "$TAG_NAME" || true
            git push origin ":refs/tags/$TAG_NAME" || true
          fi
        continue-on-error: true
      
      - name: Create Git Tag (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $VERSION"
          git push origin "$TAG_NAME"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: ${{ steps.release-notes.outputs.notes_path }}
          files: |
            artifacts/hypo-android-release-*.apk
            artifacts/hypo-android-debug-*.apk
            artifacts/Hypo-macOS-*.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
          generate_release_notes: true
          make_latest: true

