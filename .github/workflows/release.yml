name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.2.2, v1.0.0, etc.
    branches:
      - 'test/**'  # Also trigger on test branches for debugging
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.2)'
        required: true
        type: string

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Accept Android SDK Licenses
        run: |
          # Accept all Android SDK licenses
          mkdir -p "$ANDROID_HOME/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > "$ANDROID_HOME/licenses/android-googletv-license"
          echo "33b6a2b64607a11ce79713110d54f32d" > "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license"
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > "$ANDROID_HOME/licenses/intel-android-extra-license"
          echo "8403addf88ab4874007e1c1e80a0025de956b318" > "$ANDROID_HOME/licenses/google-gdk-license"
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > "$ANDROID_HOME/licenses/mips-android-sysimage-license"
      
      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
      
      - name: Build Release APK
        working-directory: android
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  build-macos:
    name: Build macOS App
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python (for icon generation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies
        run: pip install Pillow
      
      - name: Build macOS App
        working-directory: macos
        run: |
          set -e
          # Build the Swift package
          echo "Building Swift package..."
          swift build -c release
          
          # Create app bundle structure if it doesn't exist
          if [ ! -d "HypoApp.app" ]; then
            echo "Creating app bundle structure..."
            mkdir -p HypoApp.app/Contents/MacOS
            mkdir -p HypoApp.app/Contents/Resources
          fi
          
          # Copy binary to app bundle (check actual build output)
          echo "Looking for built binary..."
          # The product name is HypoMenuBar, but the target is HypoMenuBarApp
          # SwiftPM builds executables with the product name
          BINARY_FOUND=false
          if [ -f ".build/release/HypoMenuBar" ]; then
            echo "Found: .build/release/HypoMenuBar"
            cp .build/release/HypoMenuBar HypoApp.app/Contents/MacOS/HypoMenuBar
            BINARY_FOUND=true
          elif [ -f ".build/release/HypoMenuBarApp" ]; then
            echo "Found: .build/release/HypoMenuBarApp"
            cp .build/release/HypoMenuBarApp HypoApp.app/Contents/MacOS/HypoMenuBar
            BINARY_FOUND=true
          else
            echo "Error: Binary not found. Searching for executables..."
            echo "Available files in .build/release:"
            find .build/release -type f 2>/dev/null || echo "No .build/release directory found"
            echo "Available executables in .build:"
            find .build -type f -executable -name "*MenuBar*" 2>/dev/null || echo "No MenuBar executables found"
            # Try to find any executable
            EXECUTABLE=$(find .build/release -type f -executable 2>/dev/null | head -1)
            if [ -n "$EXECUTABLE" ]; then
              echo "Found executable: $EXECUTABLE, using it"
              cp "$EXECUTABLE" HypoApp.app/Contents/MacOS/HypoMenuBar
              BINARY_FOUND=true
            fi
          fi
          
          if [ "$BINARY_FOUND" = false ]; then
            exit 1
          fi
          
          chmod +x HypoApp.app/Contents/MacOS/HypoMenuBar
          echo "Binary copied successfully"
          
          # Create or update Info.plist
          echo "Creating Info.plist..."
          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          # Create Info.plist using printf to avoid YAML lint issues with heredoc
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n    <key>CFBundleExecutable</key>\n    <string>HypoMenuBar</string>\n    <key>CFBundleIdentifier</key>\n    <string>com.hypo.clipboard</string>\n    <key>CFBundleName</key>\n    <string>Hypo</string>\n    <key>CFBundlePackageType</key>\n    <string>APPL</string>\n    <key>CFBundleVersion</key>\n    <string>5</string>\n    <key>CFBundleShortVersionString</key>\n    <string>%s</string>\n    <key>LSMinimumSystemVersion</key>\n    <string>13.0</string>\n    <key>LSUIElement</key>\n    <true/>\n    <key>NSHighResolutionCapable</key>\n    <true/>\n    <key>NSPrincipalClass</key>\n    <string>NSApplication</string>\n</dict>\n</plist>\n' "${VERSION}" > HypoApp.app/Contents/Info.plist
          
          # Generate icons if script exists
          if [ -f "../scripts/generate-icons.py" ]; then
            echo "Generating icons..."
            python3 ../scripts/generate-icons.py || echo "Icon generation failed, continuing without icon"
          else
            echo "Icon generation script not found, skipping"
          fi
          
          echo "macOS app build complete"
      
      - name: Create macOS ZIP
        working-directory: macos
        run: |
          # Sanitize version string for filename (replace slashes with dashes)
          VERSION="${{ github.ref_name }}"
          SAFE_VERSION="${VERSION//\//-}"
          zip -r ../Hypo-macOS-${SAFE_VERSION}.zip HypoApp.app
      
      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: Hypo-macOS-*.zip
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-android, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog
      
      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/heads/test/* ]]; then
            # For test branches, use a test version
            VERSION="v1.0.0-test"
          else
            VERSION="${{ github.ref_name }}"
          fi
          # Remove 'v' prefix if present for tag
          TAG_NAME="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG_NAME"
      
      - name: Download Android Release APK
        uses: actions/download-artifact@v4
        with:
          name: android-release-apk
          path: ./artifacts
      
      - name: Download macOS App
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: ./artifacts
      
      - name: Rename artifacts with version
        run: |
          cd artifacts
          TAG_NAME="${{ steps.version.outputs.tag }}"
          # Rename release APK
          if [ -f "app-release.apk" ]; then
            mv app-release.apk hypo-android-release-${TAG_NAME}.apk
          else
            echo "âŒ Release APK not found!"
            exit 1
          fi
          # macOS zip already has version in name
          ls -lh
      
      - name: Generate release notes
        id: release-notes
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract changelog if available
          if [ -f changelog.md ]; then
            # Try to extract section for this version (customize as needed)
            CHANGELOG_SECTION=$(awk "/## \[?$VERSION\]?/,/## \[?v[0-9]/" changelog.md | head -n -1 || echo "")
          fi
          
          # Create release notes
          cat > release-notes.md << EOF
          # Release $VERSION
          
          ## Downloads
          
          - **Android**: \`hypo-android-release-${TAG_NAME}.apk\` (~15-20MB, optimized for production)
          - **macOS**: \`Hypo-macOS-${TAG_NAME}.zip\` (extract and move to Applications)
          
          ## Installation
          
          See [INSTALLATION.md](docs/INSTALLATION.md) for detailed installation instructions.
          
          ## Changes
          
          ${CHANGELOG_SECTION:-"See git log for changes."}
          
          ## Checksums
          
          \`\`\`
          SHA256 checksums:
          \`\`\`
          EOF
          
          # Add checksums
          cd artifacts
          for file in *.apk *.zip; do
            if [ -f "$file" ]; then
              SHA256=$(sha256sum "$file" | awk '{print $1}')
              echo "  $SHA256  $file" >> ../release-notes.md
            fi
          done
          cd ..
          
          echo "notes_path=release-notes.md" >> $GITHUB_OUTPUT
      
      - name: Delete existing release if present
        if: github.event_name == 'workflow_dispatch' && !contains(github.ref, 'refs/heads/test/')
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if gh release view "$TAG_NAME" &>/dev/null; then
            echo "Deleting existing release $TAG_NAME..."
            gh release delete "$TAG_NAME" --yes || true
          fi
        continue-on-error: true
      
      - name: Delete existing tag if present
        if: github.event_name == 'workflow_dispatch' && !contains(github.ref, 'refs/heads/test/')
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG_NAME" &>/dev/null; then
            echo "Deleting existing tag $TAG_NAME..."
            git tag -d "$TAG_NAME" || true
            git push origin ":refs/tags/$TAG_NAME" || true
          fi
        continue-on-error: true
      
      - name: Create Git Tag (if workflow_dispatch and not test branch)
        if: github.event_name == 'workflow_dispatch' && !contains(github.ref, 'refs/heads/test/')
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $VERSION"
          git push origin "$TAG_NAME"
      
      - name: Create Release
        if: github.event_name != 'push' || !contains(github.ref, 'refs/heads/test/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: ${{ steps.release-notes.outputs.notes_path }}
          files: |
            artifacts/hypo-android-release-*.apk
            artifacts/Hypo-macOS-*.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
          generate_release_notes: true

