---
title: "Hypo - Cross-Platform Clipboard Sync Architecture"
---

graph TB
    subgraph "macOS Client (Swift/SwiftUI)"
        MAC_UI[Menu Bar App<br/>SwiftUI]
        MAC_CLIP[NSPasteboard Monitor]
        MAC_HIST[Clipboard History<br/>In-Memory Store]
        MAC_NOTIF[Notification Center]
        MAC_SYNC[Sync Engine]
        MAC_CRYPTO[Crypto Module<br/>AES-256-GCM]
        MAC_KEYSTORE[File-Based Key Store<br/>Encrypted Keys]
        
        MAC_UI --> MAC_HIST
        MAC_CLIP --> MAC_SYNC
        MAC_SYNC --> MAC_CRYPTO
        MAC_SYNC --> MAC_NOTIF
        MAC_CRYPTO --> MAC_KEYSTORE
    end
    
    subgraph "Android Client (Kotlin)"
        AND_UI[Material You UI<br/>Jetpack Compose]
        AND_CLIP[ClipboardManager]
        AND_SVC[Foreground Service]
        AND_HIST[Room Database<br/>History + FTS]
        AND_SYNC[Sync Engine]
        AND_CRYPTO[Crypto Module<br/>AES-256-GCM]
        AND_KEYSTORE[EncryptedSharedPreferences<br/>Device Keys]
        AND_SMS[SMS Receiver<br/>Auto-Sync]
        
        AND_UI --> AND_HIST
        AND_CLIP --> AND_SVC
        AND_SMS --> AND_SVC
        AND_SVC --> AND_SYNC
        AND_SYNC --> AND_CRYPTO
        AND_CRYPTO --> AND_KEYSTORE
    end
    
    subgraph "Transport Layer"
        LAN[Local Network<br/>mDNS/Bonjour<br/>WebSocket over TLS]
        CLOUD[Cloud Relay<br/>WebSocket<br/>Stateless]
        
        LAN -.Fallback.-> CLOUD
    end
    
    subgraph "Backend Relay (Rust)"
        WS[WebSocket Server<br/>Actix-web]
        ROUTER[Message Router<br/>UUID-based routing]
        ERROR_HANDLER[Error Response Handler<br/>Device Not Found]
        REDIS[(Redis<br/>Ephemeral State)]
        METRICS[Prometheus Metrics<br/>Health Checks]
        
        WS --> ROUTER
        ROUTER --> ERROR_HANDLER
        ROUTER --> REDIS
        WS --> METRICS
    end
    
    MAC_SYNC <-->|Primary| LAN
    MAC_SYNC <-->|Fallback| CLOUD
    AND_SYNC <-->|Primary| LAN
    AND_SYNC <-->|Fallback| CLOUD
    
    CLOUD <--> WS
    
    subgraph "Security Layer"
        PAIR[Device Pairing<br/>QR Code Exchange]
        E2E[E2E Encryption<br/>Per-device keys]
        
        PAIR --> E2E
    end
    
    MAC_CRYPTO -.Key Management.-> E2E
    AND_CRYPTO -.Key Management.-> E2E
    
    subgraph "Protocol"
        MSG[Message Format<br/>JSON Envelope]
        
        MSG -->|Fields| ID[UUID]
        MSG -->|Fields| TS[Timestamp ISO8601]
        MSG -->|Fields| TYPE[clipboard/control/error]
        MSG -->|Fields| PAYLOAD[Encrypted Base64]
        MSG -->|Fields| DEVICE[android/macos]
        MSG -->|Fields| TARGET[Target Device ID]
        MSG -->|Fields| ENCRYPTION[Nonce + Tag]
    end
    
    ERROR_HANDLER -.Error Response.-> AND_SYNC
    ERROR_HANDLER -.Error Response.-> MAC_SYNC
    
    style MAC_UI fill:#007AFF,color:#fff
    style AND_UI fill:#3DDC84,color:#000
    style WS fill:#E43717,color:#fff
    style E2E fill:#FFD700,color:#000
    style LAN fill:#90EE90,color:#000
    style CLOUD fill:#FFB6C1,color:#000

---

## Component Responsibilities

### macOS Client
- **NSPasteboard Monitor**: Observe clipboard changes via polling (no native events)
- **Sync Engine**: De-dupe, throttle (300ms), manage transport selection, queue-based message persistence
- **History Storage**: In-memory optimized store with UserDefaults persistence, 200 item default limit
- **Key Storage**: File-based encrypted storage in `~/Library/Application Support/Hypo/` (AES-GCM)
- **Notification Center**: Rich previews with thumbnails/text snippets
- **Menu Bar App**: SwiftUI interface, search, filtering, drag-to-paste

### Android Client
- **Foreground Service**: Bypass background restrictions, maintain clipboard monitoring
- **ClipboardManager**: Primary/clip listener (API 29+)
- **SMS Receiver**: Auto-sync incoming SMS messages to clipboard (optional)
- **Room Database**: Local history with FTS4 for search, indexed queries
- **Key Storage**: EncryptedSharedPreferences for device encryption keys
- **Material You UI**: Dynamic color, adaptive layout, settings
- **Battery Optimization**: Screen-state aware connection management (60-80% battery saving)
- **MIUI/HyperOS Support**: Automatic detection and workarounds for MIUI-specific restrictions

### Transport Layer
- **LAN Discovery**: NSD (Android) + Bonjour (macOS)
- **Direct Connect**: TLS 1.3 WebSocket, mTLS for device verification
- **Cloud Relay**: Only receives encrypted blobs, routes by device UUID
- **Fallback Logic**: 3-second LAN timeout → cloud attempt

### Backend Relay
- **Stateless Design**: No persistent storage of clipboard data
- **Redis**: Ephemeral connection state (device UUID → WebSocket connection)
- **Message Routing**: UUID-based routing with device ID normalization (lowercase)
- **Error Responses**: Sends error messages when target device not found (ERROR message type)
- **Rate Limiting**: Per-device 100 req/min
- **Metrics**: Prometheus endpoints for latency/throughput, health checks
- **Deployment**: Fly.io production (https://hypo.fly.dev), auto-scaling, zero-downtime

### Security
- **Pairing**: ECDH key exchange via QR (local) or secure relay (remote)
- **Encryption**: AES-256-GCM per message, unique nonce, authentication tag
- **Key Storage**: File-based encrypted storage (macOS), EncryptedSharedPreferences (Android)
- **Key Rotation**: Every 30 days, automatic renegotiation
- **Certificate Pinning**: Prevent MITM on cloud relay
- **Device ID Normalization**: Lowercase UUIDs for consistent matching across platforms

---

## Data Flow Example: Android → macOS

1. User copies text on Android
2. ClipboardManager detects change
3. Foreground Service triggers Sync Engine
4. Sync Engine encrypts payload with shared key (AES-256-GCM)
5. Transport attempts LAN discovery (mDNS/Bonjour)
   - If found: Direct TLS WebSocket send
   - If timeout: Cloud relay send (wss://hypo.fly.dev/ws)
6. Backend receives message, routes by device UUID (normalized to lowercase)
   - If target device not found: Sends ERROR message back to sender
7. macOS Sync Engine receives encrypted message
8. Decrypts and validates authentication tag
9. Updates NSPasteboard
10. Triggers Notification Center with preview
11. Saves to in-memory history store

---

## Technology Stack

| Component | Technology |
|-----------|-----------|
| macOS App | Swift 6, SwiftUI, AppKit |
| macOS Storage | In-memory store + UserDefaults, File-based key storage |
| Android App | Kotlin 1.9.22, Jetpack Compose, Material 3 |
| Android Storage | Room + FTS4, EncryptedSharedPreferences |
| Backend | Rust 1.83+, Actix-web 4.x, Redis 7+ |
| Protocol | WebSocket (RFC 6455), JSON envelopes |
| Encryption | CryptoKit (macOS), Google Tink (Android), RustCrypto (Backend) |
| Build | Gradle (Android), SPM (macOS), Cargo (Backend) |
| Deployment | Fly.io (Backend), Local builds (Clients) |

---

## Performance Targets

- **LAN Latency**: P50 < 200ms, P95 < 500ms
- **Cloud Latency**: P50 < 1s, P95 < 3s
- **Throughput**: 10 clips/sec per device
- **Memory**: macOS < 50MB, Android < 30MB
- **Battery**: Android < 2% drain per day (foreground service)

