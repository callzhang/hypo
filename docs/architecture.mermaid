---
title: "Hypo - Cross-Platform Clipboard Sync Architecture"
---

graph TB
    subgraph "macOS Client (Swift/SwiftUI)"
        MAC_UI[Menu Bar App<br/>SwiftUI]
        MAC_CLIP[NSPasteboard Monitor]
        MAC_HIST[Clipboard History<br/>In-Memory Store]
        MAC_NOTIF[Notification Center]
        MAC_SYNC[Sync Engine]
        MAC_CRYPTO[Crypto Module<br/>AES-256-GCM]
        MAC_KEYSTORE[File-Based Key Store<br/>Encrypted Keys]
        
        MAC_UI --> MAC_HIST
        MAC_CLIP --> MAC_SYNC
        MAC_SYNC --> MAC_CRYPTO
        MAC_SYNC --> MAC_NOTIF
        MAC_CRYPTO --> MAC_KEYSTORE
    end
    
    subgraph "Android Client (Kotlin)"
        AND_UI[Material You UI<br/>Jetpack Compose]
        AND_CLIP[ClipboardManager]
        AND_SVC[Foreground Service]
        AND_HIST[Room Database<br/>History + FTS]
        AND_SYNC[Sync Engine]
        AND_CRYPTO[Crypto Module<br/>AES-256-GCM]
        AND_KEYSTORE[EncryptedSharedPreferences<br/>Device Keys]
        AND_SMS[SMS Receiver<br/>Auto-Sync]
        
        AND_UI --> AND_HIST
        AND_CLIP --> AND_SVC
        AND_SMS --> AND_SVC
        AND_SVC --> AND_SYNC
        AND_SYNC --> AND_CRYPTO
        AND_CRYPTO --> AND_KEYSTORE
    end
    
    subgraph "Transport Layer"
        LAN[Local Network<br/>mDNS/Bonjour<br/>WebSocket over TLS]
        CLOUD[Cloud Relay<br/>WebSocket<br/>Stateless]
        
        LAN -.Fallback.-> CLOUD
    end
    
    subgraph "Backend Relay (Rust)"
        WS[WebSocket Server<br/>Actix-web]
        ROUTER[Message Router<br/>UUID-based routing]
        ERROR_HANDLER[Error Response Handler<br/>Device Not Found]
        REDIS[(Redis<br/>Ephemeral State)]
        METRICS[Prometheus Metrics<br/>Health Checks]
        
        WS --> ROUTER
        ROUTER --> ERROR_HANDLER
        ROUTER --> REDIS
        WS --> METRICS
    end
    
    MAC_SYNC <-->|Primary| LAN
    MAC_SYNC <-->|Fallback| CLOUD
    AND_SYNC <-->|Primary| LAN
    AND_SYNC <-->|Fallback| CLOUD
    
    CLOUD <--> WS
    
    subgraph "Security Layer"
        PAIR[Device Pairing<br/>LAN Auto-Discovery + Code]
        E2E[E2E Encryption<br/>Per-device keys]
        
        PAIR --> E2E
    end
    
    MAC_CRYPTO -.Key Management.-> E2E
    AND_CRYPTO -.Key Management.-> E2E
    
    subgraph "Protocol"
        MSG[Message Format<br/>JSON Envelope]
        
        MSG -->|Fields| ID[UUID]
        MSG -->|Fields| TS[Timestamp ISO8601]
        MSG -->|Fields| TYPE[clipboard/control/error]
        MSG -->|Fields| PAYLOAD[Encrypted Base64]
        MSG -->|Fields| DEVICE[android/macos]
        MSG -->|Fields| TARGET[Target Device ID]
        MSG -->|Fields| ENCRYPTION[Nonce + Tag]
    end
    
    ERROR_HANDLER -.Error Response.-> AND_SYNC
    ERROR_HANDLER -.Error Response.-> MAC_SYNC
    
    style MAC_UI fill:#007AFF,color:#fff
    style AND_UI fill:#3DDC84,color:#000
    style WS fill:#E43717,color:#fff
    style E2E fill:#FFD700,color:#000
    style LAN fill:#90EE90,color:#000
    style CLOUD fill:#FFB6C1,color:#000
